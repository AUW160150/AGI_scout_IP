#!/usr/bin/env python3
"""
Voice Agent Simulation for Demo
Telnyx voice interaction 
"""
import time
import json
import sys
from datetime import datetime
from pathlib import Path

# Add parent directory to path
sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from config.settings import settings
except ImportError:
    print("âš ï¸  Running in standalone mode (config not loaded)")
    settings = None


class VoiceSimulator:
    """Simulates voice agent interaction for demo purposes"""
    
    def __init__(self):
        self.conversation_history = []
        self.session_id = f"demo_{int(datetime.now().timestamp())}"
    
    def print_slow(self, text, delay=0.03):
        """Print text with typing effect"""
        for char in text:
            print(char, end='', flush=True)
            time.sleep(delay)
        print()
    
    def simulate_call(self):
        """Simulate a complete voice interaction"""
        
        print("\n" + "="*70)
        print("ğŸ¤ VOICE AGENT DEMO SIMULATION")
        print("="*70)
        print("\nğŸ“ Calling BioIP Discovery Agent: +1-555-BIOIP\n")
        
        time.sleep(1)
        self.print_slow("ğŸ”Š [Ring... Ring...]", 0.05)
        time.sleep(2)
        self.print_slow("âœ… [Call Connected]", 0.05)
        time.sleep(1)
        
        print("\n" + "-"*70)
        
        # Agent greeting
        time.sleep(1)
        print("ğŸ¤– Agent: ", end='')
        self.print_slow(
            "Hello! I'm the BioIP Discovery Agent powered by AGI memory. "
            "I can help you find life sciences patents. What are you looking for?",
            0.02
        )
        
        # User query 1
        time.sleep(2)
        print("\nğŸ‘¤ You: ", end='')
        query1 = "Find me cancer immunotherapy technologies from Stanford"
        self.print_slow(query1, 0.04)
        self.conversation_history.append({"role": "user", "content": query1})
        
        # Agent processing
        print("\nğŸ”„ [AGI System Processing...]", end='')
        time.sleep(0.5)
        print("\n   - Searching university databases")
        time.sleep(0.5)
        print("   - Classifying with AI")
        time.sleep(0.5)
        print("   - Scoring technologies")
        time.sleep(0.5)
        print("   - Maintaining conversation context")
        time.sleep(1)
        
        # Agent response 1
        print("\nğŸ¤– Agent: ", end='')
        response1 = (
            "I found 23 cancer immunotherapy technologies from Stanford. "
            "The top-scored technology is a novel CAR-T cell therapy for solid tumors "
            "with a due diligence score of 8.7 out of 10. "
            "Would you like more details on this, or should I tell you about the top 3?"
        )
        self.print_slow(response1, 0.02)
        self.conversation_history.append({"role": "assistant", "content": response1})
        
        # User query 2 (tests memory)
        time.sleep(2)
        print("\nğŸ‘¤ You: ", end='')
        query2 = "Yes, tell me about the top 3"
        self.print_slow(query2, 0.04)
        self.conversation_history.append({"role": "user", "content": query2})
        
        # Agent processing (with memory)
        print("\nğŸ”„ [AGI Memory: Retrieved previous context...]")
        time.sleep(1)
        
        # Agent response 2
        print("\nğŸ¤– Agent: ", end='')
        response2 = (
            "Here are the top 3 cancer immunotherapy technologies:\n\n"
            "1. CAR-T therapy for solid tumors - Score 8.7\n"
            "   Clinical evidence: Phase 2 trials showing 40% response rate\n\n"
            "2. Checkpoint inhibitor combination - Score 8.5\n"
            "   Strong IP portfolio with 3 granted patents\n\n"
            "3. Tumor-infiltrating lymphocyte therapy - Score 8.2\n"
            "   FDA breakthrough designation received\n\n"
            "Would you like detailed analysis on any of these?"
        )
        self.print_slow(response2, 0.02)
        self.conversation_history.append({"role": "assistant", "content": response2})
        
        # User ends call
        time.sleep(2)
        print("\nğŸ‘¤ You: ", end='')
        query3 = "That's perfect, thank you!"
        self.print_slow(query3, 0.04)
        
        # Agent farewell
        time.sleep(1)
        print("\nğŸ¤– Agent: ", end='')
        self.print_slow(
            "You're welcome! I've saved this conversation to your AGI memory. "
            "Call back anytime - I'll remember what you're interested in. Goodbye!",
            0.02
        )
        
        # Call ended
        time.sleep(1)
        print("\n" + "-"*70)
        self.print_slow("\nğŸ“ [Call Ended]", 0.05)
        
        # Show technical details
        time.sleep(1)
        print("\n" + "="*70)
        print("ğŸ’¾ AGI MEMORY SYSTEM - SESSION DETAILS")
        print("="*70)
        print(f"\nSession ID: {self.session_id}")
        print(f"Total Messages: {len(self.conversation_history)}")
        print(f"Conversation Duration: ~2 minutes")
        print("\nStored in Memory:")
        print("  âœ“ User interest: Cancer immunotherapy")
        print("  âœ“ Preferred source: Stanford")
        print("  âœ“ Conversation context preserved")
        print("  âœ“ Ready for next interaction")
        
        print("\n" + "="*70)
        print("âœ… DEMO COMPLETE")
        print("="*70)
        print("\nKey Features Demonstrated:")
        print("  âœ“ Natural language understanding")
        print("  âœ“ AGI-style conversation memory")
        print("  âœ“ Context preservation across queries")
        print("  âœ“ Tool orchestration (search, classify, score)")
        print("  âœ“ Production-ready voice integration (code)")
        
        print("\nğŸ’¡ Note: This is a simulation showing the voice flow.")
        print("   The actual implementation uses Telnyx API with webhooks.")
        print("   The code is production-ready - just add API keys!\n")
    
    def show_architecture(self):
        """Show the technical architecture"""
        print("\n" + "="*70)
        print("ğŸ—ï¸  VOICE AGENT ARCHITECTURE")
        print("="*70)
        
        arch = """
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         USER (Phone Call)               â”‚
â”‚         via Telnyx                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Voice Agent (voice_agent.py)       â”‚
â”‚  - Call handling                        â”‚
â”‚  - Speech recognition                   â”‚
â”‚  - Text-to-speech                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      AGI Memory System                  â”‚
â”‚  - Session management                   â”‚
â”‚  - Conversation context                 â”‚
â”‚  - Tool orchestration                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Backend Services                   â”‚
â”‚  - Discovery engine                     â”‚
â”‚  - Classification (OpenAI)              â”‚
â”‚  - Analysis engine                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
"""
        print(arch)
        
        print("\nğŸ“ Implementation Files:")
        print("  â€¢ backend/voice_agent.py - Telnyx integration")
        print("  â€¢ backend/api.py - REST API endpoints")
        print("  â€¢ config/settings.py - Configuration")
        print("  â€¢ scripts/* - Discovery pipeline")
        
        print("\nğŸ”‘ Key Classes:")
        print("  â€¢ VoiceAgent - Handles call events")
        print("  â€¢ AGIClient - Manages memory & context")
        print("  â€¢ Settings - Centralized configuration")
        
        print("\n" + "="*70 + "\n")


def main():
    """Main demo function"""
    print("\n")
    print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    print("â•‘                                                               â•‘")
    print("â•‘          BioIP Discovery Agent - Voice Demo                  â•‘")
    print("â•‘                                                               â•‘")
    print("â•‘  AGI-Powered Conversational IP Discovery                     â•‘")
    print("â•‘                                                               â•‘")
    print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    
    sim = VoiceSimulator()
    
    try:
        # Run the simulation
        sim.simulate_call()
        
        # Show architecture
        time.sleep(2)
        show_arch = input("\nâ“ Show technical architecture? (y/n): ").lower()
        if show_arch == 'y':
            sim.show_architecture()
        
        # Save conversation
        time.sleep(1)
        save = input("\nâ“ Save conversation history to JSON? (y/n): ").lower()
        if save == 'y':
            output_dir = Path(__file__).parent.parent / "data" / "demos"
            output_dir.mkdir(parents=True, exist_ok=True)
            
            output_file = output_dir / f"voice_demo_{sim.session_id}.json"
            
            demo_data = {
                "session_id": sim.session_id,
                "timestamp": datetime.now().isoformat(),
                "conversation": sim.conversation_history,
                "demo_type": "voice_simulation",
                "features_demonstrated": [
                    "Natural language understanding",
                    "AGI-style conversation memory",
                    "Context preservation",
                    "Tool orchestration",
                    "Multi-turn dialogue"
                ]
            }
            
            with open(output_file, 'w') as f:
                json.dump(demo_data, f, indent=2)
            
            print(f"\nâœ… Saved to: {output_file}")
        
        print("\nğŸ‰ Demo complete! Great for showing judges the voice capability.")
        print("ğŸ’¡ Remember: The actual code in backend/voice_agent.py is production-ready!")
        print("   It just needs Telnyx API keys to go live.\n")
        
    except KeyboardInterrupt:
        print("\n\nâš ï¸  Demo interrupted. Exiting...\n")
        sys.exit(0)


if __name__ == "__main__":
    main()
